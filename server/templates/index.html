<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust C2 Framework - æ§åˆ¶å°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1>Rust C2 Framework</h1>
                <p>è¿œç¨‹æ§åˆ¶ä¸ç›‘æ§ç³»ç»Ÿ</p>
            </div>
            <picture>
                <source srcset="/static/rust-c2.svg" type="image/svg+xml">
                <img src="/static/rust-c2.png" alt="rust-c2" style="height:64px; width:auto; margin-left: 30px;" loading="lazy">
            </picture>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>{{ clients.len() }}</h3>
                <p>æ´»è·ƒå®¢æˆ·ç«¯</p>
            </div>
            <div class="stat-card">
                <h3>{{ online_clients_count }}</h3>
                <p>åœ¨çº¿å®¢æˆ·ç«¯</p>
            </div>
            <div class="stat-card">
                <h3>{{ os_types_count }}</h3>
                <p>æ“ä½œç³»ç»Ÿç±»å‹</p>
            </div>
        </div>

        <div class="main-dashboard">
            <div class="tabs">
                <div class="tab-header">
                    <div class="tab-item active" data-tab="clients">å®¢æˆ·ç«¯åˆ—è¡¨</div>
                    <div class="tab-item" data-tab="logs">æ—¥å¿—è®°å½•</div>
                    <div class="tab-item" data-tab="notes">å¤‡å¿˜å½•</div>
                    <div class="tab-item" data-tab="settings">è®¾ç½®</div>
                </div>
                
                <div class="tab-content active" id="clients-tab">
                    <div class="clients-section">
                        <div class="clients-header">
                            <h2>å®¢æˆ·ç«¯åˆ—è¡¨</h2>
                            <button class="btn refresh-btn" onclick="refreshClientList()">åˆ·æ–°</button>
                        </div>
                        
                        {% if clients.is_empty() %}
                            <div class="no-clients">
                                <h3>æš‚æ— å®¢æˆ·ç«¯è¿æ¥</h3>
                                <p>ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨...</p>
                            </div>
                        {% else %}
                            <table class="clients-table">
                                <thead>
                                    <tr>
                                        <th>å®¢æˆ·ç«¯ID</th>
                                        <th>ä¸»æœºå</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>æ“ä½œç³»ç»Ÿ</th>
                                        <th>IPåœ°å€</th>
                                        <th>è¿æ¥æ—¶é—´</th>
                                        <th>æœ€åæ´»åŠ¨</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in clients %}
                                    <tr>
                                        <td><code>{{ client.id[0..8] }}...</code></td>
                                        <td>{{ client.hostname }}</td>
                                        <td>{{ client.username }}</td>
                                        <td>{{ client.os }} ({{ client.arch }})</td>
                                        <td>{{ client.ip }}</td>
                                        <td>{{ client.connected_at.format("%Y-%m-%d %H:%M:%S") }}</td>
                                        <td>{{ client.last_seen.format("%Y-%m-%d %H:%M:%S") }}</td>
                                        <td>
                                            {% if client.is_online %}
                                                <span class="status online">åœ¨çº¿</span>
                                            {% else %}
                                                <span class="status offline">ç¦»çº¿</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="/client/{{ client.id }}" class="btn btn-sm">ç®¡ç†</a>
                                            <button class="btn btn-danger btn-sm" onclick="deleteClient('{{ client.id }}', '{{ client.hostname }}')">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>

                <div class="tab-content" id="logs-tab">
                    <div class="logs-section">
                        <div class="section-header">
                            <h2>æ—¥å¿—è®°å½•</h2>
                            <div class="logs-controls">
                                <button class="btn refresh-btn" onclick="refreshLogs()">åˆ·æ–°æ—¥å¿—</button>
                                <button class="btn btn-danger" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
                            </div>
                        </div>
                        
                        <div class="logs-filters">
                            <select id="logLevel" class="log-filter">
                                <option value="all">æ‰€æœ‰æ—¥å¿—</option>
                                <option value="CLIENT_">å®¢æˆ·ç«¯æ—¥å¿—</option>
                                <option value="COMMAND_">å‘½ä»¤æ—¥å¿—</option>
                                <option value="AUTH_">è®¤è¯æ—¥å¿—</option>
                                <option value="SESSION_">ä¼šè¯æ—¥å¿—</option>
                                <option value="FILE_">æ–‡ä»¶æ“ä½œ</option>
                                <option value="SHELL_SESSION">Shellä¼šè¯</option>
                                <option value="WEBSOCKET_">WebSocket</option>
                                <option value="ERROR">é”™è¯¯æ—¥å¿—</option>
                            </select>
                            <div class="date-range-filter">
                                <label for="startTime" class="filter-label">å¼€å§‹æ—¶é—´:</label>
                                <select id="startTime" class="log-filter time-select">
                                    <option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option>
                                </select>
                                <label for="endTime" class="filter-label">ç»“æŸæ—¶é—´:</label>
                                <select id="endTime" class="log-filter time-select">
                                    <option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option>
                                </select>
                            </div>
                            <div class="quick-time-filters">
                                <button class="btn btn-sm btn-secondary" onclick="setTimeRange('last-hour')">æœ€è¿‘1å°æ—¶</button>
                                <button class="btn btn-sm btn-secondary" onclick="setTimeRange('last-day')">æœ€è¿‘24å°æ—¶</button>
                                <button class="btn btn-sm btn-secondary" onclick="setTimeRange('today')">ä»Šå¤©</button>
                                <button class="btn btn-sm btn-secondary" onclick="setTimeRange('yesterday')">æ˜¨å¤©</button>
                            </div>
                            <button class="btn btn-sm" onclick="filterLogs()">ç­›é€‰</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                        </div>
                        
                        <div class="logs-container">
                            <div id="logsList" class="logs-list">
                                <div class="no-results">
                                    <p>åŠ è½½æ—¥å¿—ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="notes-tab">
                    <div class="notes-section">
                        <div class="section-header">
                            <h2>å¤‡å¿˜å½•</h2>
                            <button class="btn" onclick="addNote()">æ·»åŠ å¤‡å¿˜å½•</button>
                        </div>
                        
                        <div class="notes-form" id="noteForm" style="display: none;">
                            <div class="form-group">
                                <label for="noteTitle">æ ‡é¢˜</label>
                                <input type="text" id="noteTitle" class="form-input" placeholder="è¾“å…¥å¤‡å¿˜å½•æ ‡é¢˜..." />
                            </div>
                            <div class="form-group">
                                <label for="noteContent">å†…å®¹</label>
                                <textarea id="noteContent" class="form-textarea" rows="5" placeholder="è¾“å…¥å¤‡å¿˜å½•å†…å®¹..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn" onclick="saveNote()">ä¿å­˜</button>
                                <button class="btn btn-secondary" onclick="cancelNote()">å–æ¶ˆ</button>
                            </div>
                        </div>
                        
                        <div class="notes-container">
                            <div id="notesList" class="notes-list">
                                <div class="no-results">
                                    <h3>æš‚æ— å¤‡å¿˜å½•</h3>
                                    <p>ç‚¹å‡»"æ·»åŠ å¤‡å¿˜å½•"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå¤‡å¿˜å½•</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="settings-tab">
                    <div class="settings-section">
                        <div class="no-results">
                            <h3>ğŸš§ åŠŸèƒ½å¼€å‘ä¸­</h3>
                            <p>è®¾ç½®åŠŸèƒ½æ­£åœ¨é‡æ„å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...</p>
                            <div style="margin-top: 20px; color: #8b949e; font-size: 0.9em;">
                                <p>ğŸ“‹ è®¡åˆ’åŠŸèƒ½ï¼š</p>
                                <ul style="text-align: center; margin-top: 10px; list-style: none; padding: 0;">
                                    <li>æœåŠ¡å™¨é…ç½®ç®¡ç†</li>
                                    <li>å®¢æˆ·ç«¯è¿æ¥å‚æ•°è®¾ç½®</li>
                                    <li>å®‰å…¨ç­–ç•¥é…ç½®</li>
                                    <li>ç•Œé¢ä¸ªæ€§åŒ–è®¾ç½®</li>
                                    <li>ç³»ç»Ÿç›‘æ§é…ç½®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load modular JavaScript files -->
    <script src="/static/js/common.js"></script>
    <script src="/static/js/tabs.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/logs.js"></script>
    <script src="/static/js/notes.js"></script>
    <script src="/static/js/settings.js"></script>

    <script>
        let isUpdating = false;
        let notes = [];
        
        // Tabåˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabItems.forEach(tab => tab.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // ä¸ºå½“å‰tabæ·»åŠ activeç±»
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // æ ¹æ®ä¸åŒæ ‡ç­¾é¡µæ‰§è¡Œä¸åŒçš„åˆå§‹åŒ–é€»è¾‘
                    if (tabId === 'logs') {
                        loadLogs();
                    } else if (tabId === 'notes') {
                        loadNotes();
                    } else if (tabId === 'settings') {
                        loadSettings();
                    }
                });
            });
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
            loadNotes();
        });
        
        // åˆ·æ–°å®¢æˆ·ç«¯åˆ—è¡¨çš„å‡½æ•°
        async function refreshClientList() {
            if (isUpdating) return;
            isUpdating = true;
            
            try {
                const response = await fetch('/api/clients/display', {
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const data = await response.json();
                    updateDashboard(data);
                }
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            } finally {
                isUpdating = false;
            }
        }
        
        // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®
        function updateDashboard(data) {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const statCards = document.querySelectorAll('.stat-card h3');
            if (statCards.length >= 3) {
                statCards[0].textContent = data.total_clients;
                statCards[1].textContent = data.online_clients_count;
                statCards[2].textContent = data.os_types_count;
            }
            
            // æ›´æ–°å®¢æˆ·ç«¯è¡¨æ ¼
            updateClientTable(data.clients);
        }
        
        // æ›´æ–°å®¢æˆ·ç«¯è¡¨æ ¼
        function updateClientTable(clients) {
            const clientsSection = document.querySelector('.clients-section');
            let tbody = document.querySelector('.clients-table tbody');
            let table = document.querySelector('.clients-table');
            let noClientsDiv = document.querySelector('.no-clients');
            
            if (clients.length === 0) {
                // éšè—è¡¨æ ¼
                if (table) table.style.display = 'none';
                
                // åˆ›å»ºæˆ–æ˜¾ç¤ºæ— å®¢æˆ·ç«¯æ¶ˆæ¯
                if (!noClientsDiv) {
                    noClientsDiv = document.createElement('div');
                    noClientsDiv.className = 'no-clients';
                    noClientsDiv.innerHTML = '<h3>æš‚æ— å®¢æˆ·ç«¯è¿æ¥</h3><p>ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨...</p>';
                    clientsSection.appendChild(noClientsDiv);
                }
                noClientsDiv.style.display = 'block';
            } else {
                // éšè—æ— å®¢æˆ·ç«¯æ¶ˆæ¯
                if (noClientsDiv) noClientsDiv.style.display = 'none';
                
                // åˆ›å»ºè¡¨æ ¼ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!table) {
                    table = document.createElement('table');
                    table.className = 'clients-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>å®¢æˆ·ç«¯ID</th>
                                <th>ä¸»æœºå</th>
                                <th>ç”¨æˆ·å</th>
                                <th>æ“ä½œç³»ç»Ÿ</th>
                                <th>IPåœ°å€</th>
                                <th>è¿æ¥æ—¶é—´</th>
                                <th>æœ€åæ´»åŠ¨</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    clientsSection.appendChild(table);
                    tbody = table.querySelector('tbody');
                }
                
                // æ˜¾ç¤ºè¡¨æ ¼
                table.style.display = 'table';
                
                // æ›´æ–°è¡¨æ ¼å†…å®¹
                if (tbody) {
                    tbody.innerHTML = clients.map(client => `
                        <tr>
                            <td><code>${client.id.substring(0, 8)}...</code></td>
                            <td>${client.hostname}</td>
                            <td>${client.username}</td>
                            <td>${client.os} (${client.arch})</td>
                            <td>${client.ip}</td>
                            <td>${formatDateTime(client.connected_at)}</td>
                            <td>${formatDateTime(client.last_seen)}</td>
                            <td>
                                <span class="status ${client.is_online ? 'online' : 'offline'}">
                                    ${client.is_online ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                </span>
                            </td>
                            <td>
                                <a href="/client/${client.id}" class="btn btn-sm">ç®¡ç†</a>
                                <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}', '${client.hostname}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // æ—¥å¿—ç›¸å…³åŠŸèƒ½
        async function loadLogs() {
            const logsList = document.getElementById('logsList');
            logsList.innerHTML = '<div class="no-results"><p>åŠ è½½æ—¥å¿—ä¸­...</p></div>';
            
            try {
                const response = await fetch('/api/logs', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const logs = await response.text();
                    displayLogs(logs);
                } else {
                    logsList.innerHTML = '<div class="no-results"><p>æ— æ³•åŠ è½½æ—¥å¿—æ–‡ä»¶</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                logsList.innerHTML = '<div class="no-results"><p>åŠ è½½æ—¥å¿—æ—¶å‡ºé”™</p></div>';
            }
        }
        
        function displayLogs(logsText) {
            const logsList = document.getElementById('logsList');
            const lines = logsText.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                logsList.innerHTML = '<div class="no-results"><p>æš‚æ— æ—¥å¿—è®°å½•</p></div>';
                // å³ä½¿æ²¡æœ‰æ—¥å¿—ï¼Œä¹Ÿè¦æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ä¸º0
                updateLogStats([]);
                // æ¸…ç©ºæ—¶é—´é€‰æ‹©å™¨
                populateTimeSelectors([]);
                return;
            }
            
            // è§£ææ—¥å¿—æ¡ç›®å¹¶æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            const logEntries = lines.map(line => {
                const timestampMatch = line.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/);
                return {
                    text: line,
                    timestamp: timestampMatch ? new Date(timestampMatch[1]) : new Date(0),
                    timestampStr: timestampMatch ? timestampMatch[1] : null,
                    class: getLogClass(line)
                };
            }).sort((a, b) => b.timestamp - a.timestamp); // æœ€æ–°çš„åœ¨å‰
            
            const logsHtml = logEntries.map(entry => `
                <div class="log-entry ${entry.class}" title="ç‚¹å‡»å¤åˆ¶åˆ°å‰ªè´´æ¿" onclick="copyLogEntry(this)">
                    ${escapeHtml(entry.text)}
                </div>
            `).join('');
            
            logsList.innerHTML = logsHtml;
            
            // æ˜¾ç¤ºæ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
            updateLogStats(logEntries);
            
            // å¡«å……æ—¶é—´é€‰æ‹©å™¨
            populateTimeSelectors(logEntries);
        }
        
        function populateTimeSelectors(logEntries) {
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');
            
            // ä¿å­˜å½“å‰é€‰æ‹©
            const currentStartTime = startTimeSelect.value;
            const currentEndTime = endTimeSelect.value;
            
            // æ¸…ç©ºé€‰æ‹©å™¨
            startTimeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¼€å§‹æ—¶é—´</option>';
            endTimeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç»“æŸæ—¶é—´</option>';
            
            if (logEntries.length === 0) return;
            
            // æå–æ‰€æœ‰æœ‰æ•ˆçš„æ—¶é—´æˆ³
            const timestamps = logEntries
                .filter(entry => entry.timestampStr)
                .map(entry => ({
                    value: entry.timestampStr,
                    display: formatTimestampForDisplay(entry.timestampStr),
                    date: entry.timestamp
                }));
            
            // å»é‡å¹¶æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ—©çš„åœ¨å‰é¢ï¼Œç”¨äºå¼€å§‹æ—¶é—´ï¼›æœ€æ™šçš„åœ¨å‰é¢ï¼Œç”¨äºç»“æŸæ—¶é—´ï¼‰
            const uniqueTimestamps = timestamps.filter((timestamp, index, arr) => 
                arr.findIndex(t => t.value === timestamp.value) === index
            );
            
            // ä¸ºå¼€å§‹æ—¶é—´æ’åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
            const startTimestamps = [...uniqueTimestamps].sort((a, b) => a.date - b.date);
            // ä¸ºç»“æŸæ—¶é—´æ’åºï¼ˆæœ€æ™šçš„åœ¨å‰ï¼‰
            const endTimestamps = [...uniqueTimestamps].sort((a, b) => b.date - a.date);
            
            // å¡«å……å¼€å§‹æ—¶é—´é€‰æ‹©å™¨
            startTimestamps.forEach(timestamp => {
                const option = document.createElement('option');
                option.value = timestamp.value;
                option.textContent = timestamp.display;
                startTimeSelect.appendChild(option);
            });
            
            // å¡«å……ç»“æŸæ—¶é—´é€‰æ‹©å™¨
            endTimestamps.forEach(timestamp => {
                const option = document.createElement('option');
                option.value = timestamp.value;
                option.textContent = timestamp.display;
                endTimeSelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            if (currentStartTime) startTimeSelect.value = currentStartTime;
            if (currentEndTime) endTimeSelect.value = currentEndTime;
        }
        
        function formatTimestampForDisplay(timestampStr) {
            const date = new Date(timestampStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function updateLogStats(logEntries) {
            const stats = {
                total: logEntries.length,
                client: logEntries.filter(e => e.text.includes('CLIENT_')).length,
                command: logEntries.filter(e => e.text.includes('COMMAND_')).length,
                auth: logEntries.filter(e => e.text.includes('AUTH_')).length,
                session: logEntries.filter(e => e.text.includes('SESSION_')).length,
                file: logEntries.filter(e => e.text.includes('FILE_')).length,
                shell: logEntries.filter(e => e.text.includes('SHELL_SESSION')).length,
                websocket: logEntries.filter(e => e.text.includes('WEBSOCKET_')).length,
                error: logEntries.filter(e => e.text.includes('ERROR')).length
            };
            
            // åœ¨æ—¥å¿—å®¹å™¨å¤–éƒ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œä¿æŒå›ºå®šä½ç½®
            let statsElement = document.getElementById('logStats');
            if (!statsElement) {
                statsElement = document.createElement('div');
                statsElement.id = 'logStats';
                statsElement.className = 'log-stats';
                // æ’å…¥åˆ°logs-containerä¹‹å‰ï¼Œè€Œä¸æ˜¯å†…éƒ¨
                const logsContainer = document.querySelector('.logs-container');
                logsContainer.parentNode.insertBefore(statsElement, logsContainer);
            }
            
            statsElement.innerHTML = `
                <div class="stats-summary">
                    <span class="stat-item">æ€»è®¡: <strong>${stats.total}</strong></span>
                    <span class="stat-item stat-client">å®¢æˆ·ç«¯: <strong>${stats.client}</strong></span>
                    <span class="stat-item stat-command">å‘½ä»¤: <strong>${stats.command}</strong></span>
                    <span class="stat-item stat-auth">è®¤è¯: <strong>${stats.auth}</strong></span>
                    <span class="stat-item stat-session">ä¼šè¯: <strong>${stats.session}</strong></span>
                    <span class="stat-item stat-file">æ–‡ä»¶: <strong>${stats.file}</strong></span>
                    <span class="stat-item stat-shell">Shell: <strong>${stats.shell}</strong></span>
                    <span class="stat-item stat-websocket">WebSocket: <strong>${stats.websocket}</strong></span>
                    <span class="stat-item stat-error">é”™è¯¯: <strong>${stats.error}</strong></span>
                </div>
            `;
        }
        
        function copyLogEntry(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
                const originalBg = element.style.backgroundColor;
                element.style.backgroundColor = 'rgba(56, 139, 253, 0.3)';
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                }, 300);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        function getLogClass(logLine) {
            // å®¢æˆ·ç«¯ç›¸å…³
            if (logLine.includes('CLIENT_CONNECT')) return 'log-client_connect';
            if (logLine.includes('CLIENT_DISCONNECT')) return 'log-client_disconnect';
            if (logLine.includes('CLIENT_DELETE')) return 'log-client_delete';
            if (logLine.includes('CLIENT_REGISTER')) return 'log-client_register';
            if (logLine.includes('CLIENT_TIMEOUT')) return 'log-client_timeout';
            
            // å‘½ä»¤ç›¸å…³
            if (logLine.includes('COMMAND_EXECUTE')) return 'log-command_execute';
            if (logLine.includes('COMMAND_RESULT')) return 'log-command_result';
            
            // è®¤è¯ç›¸å…³
            if (logLine.includes('AUTH_FAILURE')) return 'log-auth_failure';
            
            // ä¼šè¯ç›¸å…³
            if (logLine.includes('SESSION_CREATE')) return 'log-session_create';
            if (logLine.includes('SESSION_LOGIN')) return 'log-session_login';
            if (logLine.includes('SESSION_LOGOUT')) return 'log-session_logout';
            if (logLine.includes('SESSION_VALIDATE')) return 'log-session_validate';
            
            // æ–‡ä»¶æ“ä½œç›¸å…³
            if (logLine.includes('FILE_UPLOAD')) return 'log-file_upload';
            if (logLine.includes('FILE_DOWNLOAD')) return 'log-file_download';
            if (logLine.includes('FILE_DELETE')) return 'log-file_delete';
            if (logLine.includes('FILE_LIST')) return 'log-file_list';
            
            // Shellä¼šè¯
            if (logLine.includes('SHELL_SESSION')) return 'log-shell_session';
            
            // WebSocketç›¸å…³
            if (logLine.includes('WEBSOCKET_CONNECT')) return 'log-websocket_connect';
            if (logLine.includes('WEBSOCKET_DISCONNECT')) return 'log-websocket_disconnect';
            if (logLine.includes('WEBSOCKET_MESSAGE')) return 'log-websocket_message';
            if (logLine.includes('WEBSOCKET_ERROR')) return 'log-websocket_error';
            
            // é€šç”¨åˆ†ç±» (å‘åå…¼å®¹)
            if (logLine.includes('CLIENT_')) return 'log-client';
            if (logLine.includes('COMMAND_')) return 'log-command';
            if (logLine.includes('AUTH_')) return 'log-auth';
            if (logLine.includes('SESSION_')) return 'log-session';
            if (logLine.includes('FILE_')) return 'log-file';
            if (logLine.includes('WEBSOCKET_')) return 'log-websocket';
            
            // é”™è¯¯
            if (logLine.includes('ERROR')) return 'log-error';
            
            return 'log-info';
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        async function refreshLogs() {
            await loadLogs();
        }
        
        function filterLogs() {
            const level = document.getElementById('logLevel').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const logEntries = document.querySelectorAll('.log-entry');
            
            // è½¬æ¢æ—¶é—´ä¸ºDateå¯¹è±¡
            const startDate = startTime ? new Date(startTime) : null;
            const endDate = endTime ? new Date(endTime) : null;
            
            logEntries.forEach(entry => {
                let show = true;
                const logText = entry.textContent;
                
                // ç­›é€‰æ—¥å¿—çº§åˆ«/ç±»å‹
                if (level !== 'all' && !logText.includes(level)) {
                    show = false;
                }
                
                // ç­›é€‰æ—¶é—´èŒƒå›´ - å¤„ç†æ—¥å¿—æ ¼å¼ [2025-07-12 01:39:48]
                if (startDate || endDate) {
                    const logDateMatch = logText.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/);
                    if (logDateMatch) {
                        const logTime = new Date(logDateMatch[1]);
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…
                        if (startDate && logTime < startDate) {
                            show = false;
                        }
                        if (endDate && logTime > endDate) {
                            show = false;
                        }
                    } else {
                        // å¦‚æœæ— æ³•è§£ææ—¶é—´ï¼Œä¸”è®¾ç½®äº†æ—¶é—´ç­›é€‰ï¼Œåˆ™éšè—
                        if (startDate || endDate) {
                            show = false;
                        }
                    }
                }
                
                entry.style.display = show ? 'block' : 'none';
            });
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœç»Ÿè®¡
            const visibleEntries = Array.from(logEntries).filter(entry => entry.style.display !== 'none');
            const totalEntries = logEntries.length;
            
            // åœ¨ç­›é€‰åŒºåŸŸæ˜¾ç¤ºç»“æœç»Ÿè®¡
            let statusElement = document.getElementById('filterStatus');
            if (!statusElement) {
                statusElement = document.createElement('span');
                statusElement.id = 'filterStatus';
                statusElement.style.color = '#8b949e';
                statusElement.style.fontSize = '0.85em';
                statusElement.style.marginLeft = 'auto';
                document.querySelector('.logs-filters').appendChild(statusElement);
            }
            
            if (level !== 'all' || startTime || endTime) {
                const timeRangeText = getTimeRangeText(startTime, endTime);
                statusElement.textContent = `æ˜¾ç¤º ${visibleEntries.length} / ${totalEntries} æ¡æ—¥å¿—${timeRangeText}`;
            } else {
                statusElement.textContent = '';
            }
        }
        
        function getTimeRangeText(startTime, endTime) {
            if (!startTime && !endTime) return '';
            
            const formatDisplayTime = (timeStr) => {
                const date = new Date(timeStr);
                return date.toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            if (startTime && endTime) {
                return ` (${formatDisplayTime(startTime)} ~ ${formatDisplayTime(endTime)})`;
            } else if (startTime) {
                return ` (${formatDisplayTime(startTime)} ä¹‹å)`;
            } else {
                return ` (${formatDisplayTime(endTime)} ä¹‹å‰)`;
            }
        }
        
        function setTimeRange(range) {
            // å¿«é€Ÿæ—¶é—´èŒƒå›´åŠŸèƒ½ç°åœ¨åªæ¸…é™¤é€‰æ‹©å™¨ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨é€‰æ‹©
            clearFilters();
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const statusElement = document.getElementById('filterStatus');
            if (statusElement) {
                switch (range) {
                    case 'last-hour':
                        statusElement.textContent = 'è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©æœ€è¿‘1å°æ—¶çš„æ—¶é—´èŒƒå›´';
                        break;
                    case 'last-day':
                        statusElement.textContent = 'è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©æœ€è¿‘24å°æ—¶çš„æ—¶é—´èŒƒå›´';
                        break;
                    case 'today':
                        statusElement.textContent = 'è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ä»Šå¤©çš„æ—¶é—´èŒƒå›´';
                        break;
                    case 'yesterday':
                        statusElement.textContent = 'è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©æ˜¨å¤©çš„æ—¶é—´èŒƒå›´';
                        break;
                }
                
                // 3ç§’åæ¸…é™¤æç¤º
                setTimeout(() => {
                    if (statusElement.textContent.includes('è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©')) {
                        statusElement.textContent = '';
                    }
                }, 3000);
            }
        }
        
        function clearFilters() {
            // é‡ç½®ç­›é€‰æ§ä»¶
            document.getElementById('logLevel').value = 'all';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            
            // æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—æ¡ç›®
            const logEntries = document.querySelectorAll('.log-entry');
            logEntries.forEach(entry => {
                entry.style.display = 'block';
            });
            
            // æ¸…é™¤ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('filterStatus');
            if (statusElement) {
                statusElement.textContent = '';
            }
        }
        
        async function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
                try {
                    const response = await fetch('/api/logs/clear', {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            alert(result.message);
                            // æ¸…é™¤ç­›é€‰æ¡ä»¶
                            clearFilters();
                            // æ¸…é™¤åé‡æ–°åŠ è½½æ—¥å¿—ï¼ˆåº”è¯¥ä¸ºç©ºï¼‰
                            await loadLogs();
                        } else {
                            alert('æ¸…é™¤æ—¥å¿—å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } else {
                        alert('æ¸…é™¤æ—¥å¿—å¤±è´¥: HTTP ' + response.status);
                    }
                } catch (error) {
                    console.error('æ¸…é™¤æ—¥å¿—æ—¶å‡ºé”™:', error);
                    alert('æ¸…é™¤æ—¥å¿—æ—¶å‡ºé”™: ' + error.message);
                }
            }
        }
        
        // å¤‡å¿˜å½•ç›¸å…³åŠŸèƒ½
        async function loadNotes() {
            const notesList = document.getElementById('notesList');
            
            try {
                const response = await fetch('/api/notes', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    notes = await response.json();
                } else {
                    console.error('Failed to load notes:', response.status);
                    notes = [];
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                notes = [];
            }
            
            if (notes.length === 0) {
                notesList.innerHTML = `
                    <div class="no-results">
                        <h3>æš‚æ— å¤‡å¿˜å½•</h3>
                        <p>ç‚¹å‡»"æ·»åŠ å¤‡å¿˜å½•"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå¤‡å¿˜å½•</p>
                    </div>
                `;
                return;
            }
            
            const notesHtml = notes.map((note, index) => `
                <div class="note-item">
                    <div class="note-header">
                        <h4>${escapeHtml(note.title)}</h4>
                        <div class="note-actions">
                            <button class="btn btn-sm" onclick="editNote('${note.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNote('${note.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-meta">åˆ›å»ºæ—¶é—´: ${note.created_at}${note.updated_at ? ' | æ›´æ–°æ—¶é—´: ' + note.updated_at : ''}</div>
                </div>
            `).join('');
            
            notesList.innerHTML = notesHtml;
        }
        
        function addNote() {
            document.getElementById('noteForm').style.display = 'block';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTitle').focus();
        }
        
        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            const note = {
                id: '',
                title: title,
                content: content,
                created_at: '',
                updated_at: null
            };
            
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(note)
                });
                
                if (response.ok) {
                    cancelNote();
                    await loadNotes();
                } else {
                    alert('ä¿å­˜å¤‡å¿˜å½•å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('ä¿å­˜å¤‡å¿˜å½•æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        function cancelNote() {
            document.getElementById('noteForm').style.display = 'none';
        }
        
        function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                alert('æœªæ‰¾åˆ°è¯¥å¤‡å¿˜å½•');
                return;
            }
            
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteForm').style.display = 'block';
            
            // æ›´æ–°ä¿å­˜æŒ‰é’®ä¸ºæ›´æ–°åŠŸèƒ½
            const saveBtn = document.querySelector('#noteForm .btn');
            saveBtn.textContent = 'æ›´æ–°';
            saveBtn.onclick = () => updateNote(noteId);
        }
        
        async function updateNote(noteId) {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            const note = {
                id: noteId,
                title: title,
                content: content,
                created_at: '',
                updated_at: null
            };
            
            try {
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(note)
                });
                
                if (response.ok) {
                    // æ¢å¤ä¿å­˜æŒ‰é’®
                    const saveBtn = document.querySelector('#noteForm .btn');
                    saveBtn.textContent = 'ä¿å­˜';
                    saveBtn.onclick = saveNote;
                    
                    cancelNote();
                    await loadNotes();
                } else {
                    alert('æ›´æ–°å¤‡å¿˜å½•å¤±è´¥: ' + response.status);
                }
            } catch (error) {
                console.error('Error updating note:', error);
                alert('æ›´æ–°å¤‡å¿˜å½•æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        async function deleteNote(noteId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤‡å¿˜å½•å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/notes/${noteId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        await loadNotes();
                    } else {
                        alert('åˆ é™¤å¤‡å¿˜å½•å¤±è´¥: ' + response.status);
                    }
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('åˆ é™¤å¤‡å¿˜å½•æ—¶å‡ºé”™: ' + error.message);
                }
            }
        }
        
        // è®¾ç½®ç›¸å…³åŠŸèƒ½
        function loadSettings() {
            // ä»localStorageåŠ è½½è®¾ç½®æˆ–ä½¿ç”¨é»˜è®¤å€¼
            const settings = JSON.parse(localStorage.getItem('c2-settings') || '{}');
            
            if (settings.refreshInterval) {
                document.getElementById('refreshInterval').value = settings.refreshInterval;
            }
        }
        
        function saveSettings() {
            const settings = {
                serverHost: document.getElementById('serverHost').value,
                serverPort: document.getElementById('serverPort').value,
                clientTimeout: document.getElementById('clientTimeout').value,
                refreshInterval: document.getElementById('refreshInterval').value,
                maxClients: document.getElementById('maxClients').value,
                enableAuth: document.getElementById('enableAuth').checked,
                enableAudit: document.getElementById('enableAudit').checked
            };
            
            localStorage.setItem('c2-settings', JSON.stringify(settings));
            alert('è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        }
        
        function resetSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
                localStorage.removeItem('c2-settings');
                location.reload();
            }
        }
        
        function restartServer() {
            if (confirm('ç¡®å®šè¦é‡å¯æœåŠ¡å™¨å—ï¼Ÿè¿™å°†æ–­å¼€æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥ã€‚')) {
                alert('é‡å¯æœåŠ¡å™¨åŠŸèƒ½éœ€è¦åç«¯APIæ”¯æŒ');
            }
        }
        
        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        const refreshInterval = parseInt("{{ refresh_interval }}") || 5;
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨å®šæ—¶å™¨
        setTimeout(() => {
            setInterval(() => {
                // åªæœ‰åœ¨å®¢æˆ·ç«¯åˆ—è¡¨æ ‡ç­¾é¡µæ¿€æ´»æ—¶æ‰è‡ªåŠ¨åˆ·æ–°
                if (document.querySelector('.tab-item[data-tab="clients"]').classList.contains('active')) {
                    refreshClientList();
                }
            }, refreshInterval * 1000);
        }, 1000);
        
        // åˆ é™¤å®¢æˆ·ç«¯åŠŸèƒ½
        async function deleteClient(clientId, hostname) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ·ç«¯ "${hostname}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†:\n- åˆ é™¤å®¢æˆ·ç«¯è®°å½•\n- æ¸…é™¤ç›¸å…³å‘½ä»¤å†å²\n- æ¸…é™¤æ–‡ä»¶æ“ä½œè®°å½•\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                try {
                    const response = await fetch(`/api/clients/${clientId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert('å®¢æˆ·ç«¯åˆ é™¤æˆåŠŸ');
                        // åˆ·æ–°å®¢æˆ·ç«¯åˆ—è¡¨
                        await refreshClientList();
                    } else if (response.status === 404) {
                        alert('å®¢æˆ·ç«¯ä¸å­˜åœ¨');
                        // ä»ç„¶åˆ·æ–°åˆ—è¡¨ï¼Œä»¥é˜²æ•°æ®ä¸åŒæ­¥
                        await refreshClientList();
                    } else {
                        alert('åˆ é™¤å®¢æˆ·ç«¯å¤±è´¥: HTTP ' + response.status);
                    }
                } catch (error) {
                    console.error('åˆ é™¤å®¢æˆ·ç«¯æ—¶å‡ºé”™:', error);
                    alert('åˆ é™¤å®¢æˆ·ç«¯æ—¶å‡ºé”™: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>