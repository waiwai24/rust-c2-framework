# Rust C2 Framework - 反弹Shell架构图

## 整体架构流程

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│   前端Web界面   │    │   服务器端组件    │    │    客户端组件       │
│  (Browser UI)   │    │  (Server Side)   │    │  (Client Side)     │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
         │                        │                         │
         │                        │                         │
         ▼                        ▼                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│ client.html     │    │ AppState +       │    │ main.rs +           │
│ reverse-shell.js│◄──►│ Handlers         │◄──►│ command_executor.rs │
│ WebSocket       │    │ WebSocket Server │    │ shell.rs            │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
```

## 详细组件架构

### 1. 客户端组件 (Client Components)

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端 (Client)                         │
├─────────────────────────────────────────────────────────────┤
│ main.rs                                                     │
│ ├─ 连接到服务器                                              │
│ ├─ 心跳检测                                                  │
│ └─ 接收命令调度                                              │
├─────────────────────────────────────────────────────────────┤
│ command_executor.rs                                         │
│ ├─ 执行反弹Shell命令                                         │
│ ├─ 使用Cipher加密敏感数据                                    │
│ └─ 返回加密的命令响应                                        │
├─────────────────────────────────────────────────────────────┤
│ shell.rs                                                    │
│ ├─ start_reverse_shell(shellcode)                          │
│ ├─ fork()进程 + ptrace操作                                  │
│ ├─ 注入shellcode到子进程                                    │
│ └─ 执行/bin/bash建立反向连接                                 │
└─────────────────────────────────────────────────────────────┘
```

### 2. 服务器端组件 (Server Components)

```
┌─────────────────────────────────────────────────────────────┐
│                     服务器 (Server)                         │
├─────────────────────────────────────────────────────────────┤
│ main.rs + AppState                                          │
│ ├─ HTTP/WebSocket服务器启动                                  │
│ ├─ 客户端管理器初始化                                        │
│ ├─ Shell管理器初始化                                         │
│ └─ 反弹Shell监听器启动                                       │
├─────────────────────────────────────────────────────────────┤
│ handlers/api.rs                                             │
│ ├─ POST /api/clients/{id}/reverse_shell                     │
│ ├─ 使用Cipher解密客户端数据                                  │
│ ├─ 发送反弹Shell启动命令                                     │
│ └─ WebSocket连接管理                                         │
├─────────────────────────────────────────────────────────────┤
│ handlers/web.rs                                             │
│ ├─ WebSocket升级处理                                         │
│ ├─ 实时数据广播                                              │
│ └─ 客户端状态渲染                                            │
├─────────────────────────────────────────────────────────────┤
│ reverse_shell_listener.rs                                   │
│ ├─ TCP监听器 (端口监听)                                      │
│ ├─ ReverseShellManager                                      │
│ ├─ 连接ID管理 (UUID)                                        │
│ └─ 双向数据流处理                                            │
├─────────────────────────────────────────────────────────────┤
│ managers/shell_manager.rs                                   │
│ ├─ ShellSession管理                                         │
│ ├─ mpsc::channel通信                                        │
│ ├─ broadcast::channel输出                                   │
│ └─ 会话生命周期管理                                          │
└─────────────────────────────────────────────────────────────┘
```

### 3. 前端组件 (Frontend Components)

```
┌─────────────────────────────────────────────────────────────┐
│                   前端界面 (Frontend)                       │
├─────────────────────────────────────────────────────────────┤
│ client.html                                                 │
│ ├─ 客户端信息显示                                            │
│ ├─ 反弹Shell控制面板                                         │
│ ├─ 终端界面                                                  │
│ └─ 文件管理界面                                              │
├─────────────────────────────────────────────────────────────┤
│ reverse-shell.js                                            │
│ ├─ startReverseShell()                                      │
│ ├─ WebSocket连接管理                                         │
│ ├─ 实时命令输入/输出                                         │
│ └─ 连接状态显示                                              │
├─────────────────────────────────────────────────────────────┤
│ CSS样式文件                                                  │
│ ├─ reverse-shell.css                                        │
│ ├─ command-execution.css                                    │
│ └─ 响应式布局样式                                            │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向图

### 启动反弹Shell流程

```
前端 ──────1.点击启动────────► API Handler ──────2.发送命令────────► 客户端
 │                              │                                │
 │                              │                                │
 │◄─────3.返回响应──────────────┤                                │
 │                              │                                ▼
 │                              │                          执行shell.rs
 │                              │                          fork() + ptrace
 │                              │                          注入shellcode
 │                              │                                │
 │                              │                                ▼
 │                              │◄────4.TCP连接──────────────── /bin/bash
 │                              │                           反向连接
 │                              ▼
 │                     ReverseShellListener
 │                     创建connection_id
 │                            │
 │◄────5.WebSocket更新────────┤
```

### 实时通信流程

```
前端WebSocket ◄──────────────► HTTP/WebSocket服务器
      │                              │
      │                              │
      ▼                              ▼
   终端界面                    ShellManager
   命令输入                    ├─ mpsc::Sender
   输出显示                    ├─ broadcast::Receiver  
      │                       └─ 会话数据管理
      │                              │
      │                              ▼
      │                     ReverseShellManager
      │                     ├─ 连接映射管理
      │                     ├─ 数据双向转发
      │                     └─ 连接状态跟踪
      │                              │
      │                              ▼
      └──────────────────────► TCP反弹Shell连接
                                   (客户端建立)
```

## 关键技术点

### 1. 加密通信
- **位置**: `common/src/crypto.rs`, `client/src/command_executor.rs:88`, `server/src/handlers/api.rs:194`
- **实现**: AES-256-GCM加密，32字节密钥
- **用途**: 保护敏感命令执行结果

### 2. 进程注入
- **位置**: `client/src/shell.rs:11-67`
- **技术**: fork() + ptrace + shellcode注入
- **目标**: 在子进程中执行反弹Shell

### 3. 实时通信
- **WebSocket**: 前端与服务器实时双向通信
- **mpsc/broadcast**: 服务器内部异步消息传递
- **TCP监听**: 接收客户端反弹连接

### 4. 连接管理
- **UUID**: 每个反弹Shell连接分配唯一ID
- **Session**: 会话生命周期管理和清理
- **状态跟踪**: 连接状态实时更新

## 安全特性

1. **命令加密**: 敏感数据通过AES-256-GCM加密传输
2. **审计日志**: 所有操作记录到审计系统
3. **连接验证**: 客户端身份验证和授权
4. **进程隐藏**: 反弹Shell进程的隐蔽执行

此架构实现了完整的反弹Shell功能，包含安全的通信机制、实时的Web界面管理和robust的连接处理。